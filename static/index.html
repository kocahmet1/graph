<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veritas AI Araçları</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #f8fafc;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .glass-card {
            background: rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-radius: 1.5rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-weight: 500;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 40px;
            height: 40px;
            animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .textarea-modern {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1rem;
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            resize: vertical;
            color: #e2e8f0;
        }

        .textarea-modern:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            outline: none;
            background: rgba(255, 255, 255, 0.05);
        }

        .file-upload {
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .file-upload:hover {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .glow {
            position: fixed;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.35) 0%, rgba(99, 102, 241, 0) 85%);
            pointer-events: none;
            mix-blend-mode: screen;
            animation: glow-move 8s infinite alternate;
            filter: blur(60px);
            /* Temporarily disabled */
            display: none;
        }

        @keyframes glow-move {
            0% { transform: translate(-30%, -30%) scale(1.4); }
            100% { transform: translate(30%, 30%) scale(2.0); }
        }

        @keyframes tooltip-fade {
            0%, 100% { opacity: 0; }
            20%, 80% { opacity: 1; }
        }

        .animate-tooltip {
            animation: tooltip-fade 5s ease-in-out;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Toggle switch styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #6366f1;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .model-mode {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .model-mode-label {
            font-size: 0.875rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="p-6">
    <div class="glow top-0 left-0"></div>
    <div class="glow bottom-0 right-0"></div>

    <div class="max-w-6xl mx-auto relative">
        <div class="absolute top-3 left-3">
            <span class="text-sm uppercase tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-300" style="letter-spacing: 0.2em;">Veritas Academy</span>
        </div>
        <h1 class="text-5xl font-bold text-center mb-6 text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">Veritas AI Araçları</h1>
        
        <!-- Model Preference Toggle -->
        <div class="flex justify-center mb-8">
            <div class="glass-card p-3 inline-flex items-center gap-4">
                <div class="model-mode">
                    <span class="model-mode-label">Hızlı Mod</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="modelToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="model-mode-label">Kaliteli Mod</span>
                </div>
                <div class="relative group">
                    <svg class="w-5 h-5 text-indigo-300 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div class="absolute left-0 bottom-full mb-2 w-64 p-2 bg-indigo-600/90 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 backdrop-blur-sm z-10">
                        <p>Hızlı Mod: Daha hızlı sonuçlar için gemini-2.0-flash modeli kullanılır.</p>
                        <p class="mt-1">Kaliteli Mod: Daha yüksek kalitede sonuçlar için gelişmiş gemini-2.5-pro modeli kullanılır (yavaş).</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API Key Input -->
        <div class="flex justify-center mb-8">
            <div class="glass-card p-4 w-full max-w-xl">
                <div class="flex items-center mb-2">
                    <h3 class="text-md font-semibold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">Google API Anahtarı</h3>
                    <div class="relative ml-2 group">
                        <svg class="w-5 h-5 text-indigo-300 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="absolute left-0 bottom-full mb-2 w-72 p-2 bg-indigo-600/90 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 backdrop-blur-sm z-10">
                            <p>Google Generative AI modellerini kullanmak için kendi API anahtarınızı girin. API anahtarı almak için <a href="https://ai.google.dev/tutorials/setup" target="_blank" class="underline">Google AI Studio</a> sitesini ziyaret edin.</p>
                        </div>
                    </div>
                </div>
                <div class="flex">
                    <input type="password" id="apiKeyInput" placeholder="Google API Anahtarınızı Girin" class="textarea-modern w-full mr-2" />
                    <button id="saveApiKeyBtn" class="btn-primary whitespace-nowrap">Kullan</button>
                </div>
                <div id="apiKeyStatus" class="text-xs mt-2 hidden"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8"></div>
            
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Sol Sütun -->
            <div class="space-y-6">
                <!-- Yükleme Bölümü -->
                <div class="glass-card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">Resimdeki Soruyu Tekrar oluştur/Temizle(Grafikli olan Sorular)</h2>
                    <label class="file-upload block">
                        <input type="file" id="imageUpload" accept="image/*" class="hidden" onchange="previewImage(this)">
                        <div id="uploadArea" class="text-indigo-200">
                            <svg class="w-12 h-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <p class="text-sm">İşlenecek soru resmini buraya sürükleyip bırakın veya seçmek için tıklayın</p>
                        </div>
                        <div id="previewArea" class="hidden mt-4">
                            <img id="preview" class="max-h-32 mx-auto rounded-lg">
                        </div>
                    </label>
                    <button onclick="uploadImage()" class="btn-primary w-full mt-4">
                        Oluştur
                    </button>
                </div>

                <!-- Soru Bilgisi -->
                <div id="questionInfo" class="glass-card p-6 hidden">
                    <h2 class="text-xl font-semibold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">Soru Bilgisi</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-medium text-indigo-200">Soru:</h3>
                            <p id="questionText" class="mt-1 text-gray-300"></p>
                        </div>
                        <div>
                            <h3 class="font-medium text-indigo-200">Cevap Seçenekleri:</h3>
                            <ul id="answerChoices" class="list-disc pl-5 mt-1 text-gray-300"></ul>
                        </div>
                    </div>
                </div>
                
                <!-- Yeni Özellik: Soru Üretme -->
                <div class="glass-card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">Yeni Soru Üretme</h2>
                    <p class="text-sm mb-4 text-gray-300">Bir soru görselini yükleyin, yapay zeka soruyu okuyacak ve benzer tipte yeni bir soru oluşturacak.</p>
                    
                    <div class="file-upload mb-4" id="questionImageUpload">
                        <input type="file" id="questionImageInput" accept="image/*" class="hidden" />
                        <div class="flex flex-col items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <p class="text-sm">Soru görseli yüklemek için tıklayın veya sürükleyin</p>
                        </div>
                    </div>
                    
                    <div id="questionPreviewContainer" class="hidden mb-4">
                        <p class="text-sm font-medium mb-2">Yüklenen Görsel:</p>
                        <div class="aspect-w-16 aspect-h-9 bg-black/20 rounded-lg overflow-hidden">
                            <img id="questionPreview" src="" alt="Önizleme" class="object-contain w-full h-full" />
                        </div>
                        <div class="flex justify-end mt-2">
                            <button id="cancelQuestionUpload" class="text-xs text-red-400 hover:text-red-300">İptal</button>
                        </div>
                    </div>
                    
                    <button id="generateNewQuestionBtn" class="btn-primary w-full mt-2 mb-4 hidden">
                        <span>Yeni Soru Oluştur</span>
                    </button>
                </div>

                <!-- Açıklama Bölümü -->
                <div class="glass-card p-6">
                    <div class="flex items-center mb-4">
                        <h2 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">Tarif Ederek Yeni Grafik Oluştur</h2>
                        <div class="relative ml-2 group">
                            <svg class="w-5 h-5 text-indigo-300 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div class="absolute left-0 bottom-full mb-2 w-64 p-2 bg-indigo-600/90 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 backdrop-blur-sm">
                                İstediğiniz grafiği doğal dille tarif edin. Matematiksel ifadeler kullanabilirsiniz.
                            </div>
                        </div>
                    </div>
                    <div class="text-sm text-indigo-200 mb-2">Örnek ifadeler:</div>
                    <div class="text-xs text-indigo-300 mb-4 space-y-1">
                        <div>• "x² + 5x + 5 fonksiyonunun grafiğini çiz"</div>
                        <div>• "sin(x) fonksiyonunun [-π, π] aralığındaki grafiği"</div>
                        <div>• "y = 2x + 3 doğrusunu koordinat düzleminde göster"</div>
                        <div>• "x ekseni ile 30° ve 60° açı yapan iki doğru çiz"</div>
                    </div>
                    <textarea id="description" class="textarea-modern w-full" rows="10" placeholder="Grafik açıklamasını buraya girin..."></textarea>
                    <button onclick="generateGraph()" class="btn-primary w-full mt-4">
                        Grafik Oluştur
                    </button>
                </div>
            </div>

            <!-- Sağ Sütun -->
            <div class="glass-card p-6">
                <h2 class="text-xl font-semibold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">Oluşturulan Soru</h2>
                <div class="flex flex-col">
                    <div id="captureArea" class="bg-white rounded-lg overflow-hidden">
                        <div id="graphContainer" class="w-full flex flex-col justify-center items-center min-h-[400px]">
                            <p class="text-gray-500 py-8">Oluşturulan grafik burada görünecek...</p>
                        </div>
                        <div id="questionDisplayArea" class="w-full p-4 text-black hidden">
                            <p id="displayQuestionText" class="mb-3 text-base leading-relaxed"></p>
                            <ul id="displayAnswerChoices" class="list-disc pl-5 text-base leading-relaxed"></ul>
                        </div>
                        <!-- Question Result Container (Used by question generation feature) -->
                        <div id="questionResult" class="hidden">
                            <div class="bg-indigo-900/30 rounded-lg p-4 mb-4">
                                <h3 class="text-md font-medium mb-2 text-indigo-200">Orijinal İçerik:</h3>
                                <div id="originalPassageContainer" class="mb-4 hidden">
                                    <h4 class="text-sm font-medium mb-1 text-indigo-300">Parça/Metin:</h4>
                                    <div id="originalPassage" class="text-sm mb-3 text-gray-300 whitespace-pre-line border-l-2 border-indigo-700 pl-3"></div>
                                </div>
                                <div class="mb-2">
                                    <h4 class="text-sm font-medium mb-1 text-indigo-300">Soru:</h4>
                                    <p id="originalQuestion" class="text-sm mb-2 text-gray-300"></p>
                                </div>
                                <div>
                                    <h4 class="text-sm font-medium mb-1 text-indigo-300">Şıklar:</h4>
                                    <div id="originalAnswers" class="text-sm text-gray-400 grid grid-cols-1 md:grid-cols-2 gap-2"></div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-md font-medium text-black">Yeni İçerik:</h3>
                                    <button id="downloadQuestionBtn" class="text-sm px-3 py-1 bg-indigo-500 hover:bg-indigo-600 text-white rounded transition-colors flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        JPG olarak indir
                                    </button>
                                </div>
                                
                                <!-- Capture area for download - title is outside this div -->
                                <div id="questionCaptureArea" class="bg-white">
                                    <div id="newPassageContainer" class="mb-4 hidden border-b pb-3 border-gray-200">
                                        <div id="newPassage" class="text-black whitespace-pre-line text-sm"></div>
                                    </div>
                                    <div id="newQuestionContainer" class="mb-3">
                                        <p id="newQuestion" class="text-black text-sm font-medium"></p>
                                    </div>
                                    <div id="newAnswers" class="flex flex-col space-y-2">
                                        <!-- New answers will be populated here by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="downloadImageBtn" onclick="downloadAsImage()" class="btn-primary mt-4 hidden">
                        Resim Olarak İndir (JPG)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Yükleme Ekranı -->
    <div id="loading" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="glass-card p-8 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p id="loadingText" class="text-indigo-200">İşleniyor...</p>
        </div>
    </div>

    <script>
        // Model preference toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Question generation feature setup
            setupQuestionGenerationFeature();
            
            // Get the current model preference when the page loads
            fetch('/api/get-model-preference')
                .then(response => response.json())
                .then(data => {
                    const toggle = document.getElementById('modelToggle');
                    // If preference is 'slow', check the toggle (since slow mode is on the checked side)
                    toggle.checked = data.preference === 'slow';
                })
                .catch(error => console.error('Error fetching model preference:', error));
            
            // Add event listener for the toggle change
            document.getElementById('modelToggle').addEventListener('change', function() {
                const preference = this.checked ? 'slow' : 'fast';
                showModelChangeLoading(preference);
                
                fetch('/api/toggle-model-preference', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ preference }),
                })
                .then(response => response.json())
                .then(data => {
                    hideModelChangeLoading();
                    if (data.status === 'success') {
                        showModelChangeToast(preference);
                    } else {
                        console.error('Failed to change model preference:', data.error);
                    }
                })
                .catch(error => {
                    hideModelChangeLoading();
                    console.error('Error changing model preference:', error);
                });
            });
            
            // API Key functionality
            // Check if there's an API key set
            fetch('/api/get-api-key')
                .then(response => response.json())
                .then(data => {
                    const apiKeyInput = document.getElementById('apiKeyInput');
                    const apiKeyStatus = document.getElementById('apiKeyStatus');
                    
                    if (data.hasApiKey) {
                        apiKeyInput.placeholder = "••••••••••••••••••••••••••••••";
                        apiKeyStatus.textContent = "✓ API anahtarı ayarlanmış";
                        apiKeyStatus.classList.remove('hidden', 'text-red-400');
                        apiKeyStatus.classList.add('text-green-400');
                    } else {
                        apiKeyStatus.textContent = "⚠️ Lütfen API anahtarınızı girin";
                        apiKeyStatus.classList.remove('hidden', 'text-green-400');
                        apiKeyStatus.classList.add('text-red-400');
                    }
                    
                    apiKeyStatus.classList.remove('hidden');
                })
                .catch(error => console.error('Error checking API key status:', error));
            
            // Save API key button handler
            document.getElementById('saveApiKeyBtn').addEventListener('click', function() {
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                const apiKeyStatus = document.getElementById('apiKeyStatus');
                
                if (!apiKey) {
                    apiKeyStatus.textContent = "⚠️ Lütfen geçerli bir API anahtarı girin";
                    apiKeyStatus.classList.remove('hidden', 'text-green-400');
                    apiKeyStatus.classList.add('text-red-400');
                    return;
                }
                
                // Show loading while saving API key
                showModelChangeLoading("API Anahtarı Kaydediliyor...");
                
                fetch('/api/update-api-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ api_key: apiKey }),
                })
                .then(response => response.json())
                .then(data => {
                    hideModelChangeLoading();
                    
                    if (data.status === 'success') {
                        // Clear the input field and show success message
                        document.getElementById('apiKeyInput').value = '';
                        document.getElementById('apiKeyInput').placeholder = "••••••••••••••••••••••••••••••";
                        
                        apiKeyStatus.textContent = "✓ API anahtarı başarıyla kaydedildi";
                        apiKeyStatus.classList.remove('hidden', 'text-red-400');
                        apiKeyStatus.classList.add('text-green-400');
                        
                        // Show success toast
                        showApiKeyToast(true);
                    } else {
                        apiKeyStatus.textContent = "⚠️ API anahtarı kaydedilemedi: " + data.error;
                        apiKeyStatus.classList.remove('hidden', 'text-green-400');
                        apiKeyStatus.classList.add('text-red-400');
                        
                        // Show error toast
                        showApiKeyToast(false, data.error);
                    }
                })
                .catch(error => {
                    hideModelChangeLoading();
                    console.error('Error saving API key:', error);
                    
                    apiKeyStatus.textContent = "⚠️ API anahtarı kaydedilemedi";
                    apiKeyStatus.classList.remove('hidden', 'text-green-400');
                    apiKeyStatus.classList.add('text-red-400');
                });
            });
        });
        
        function showModelChangeLoading(message) {
            // Show loading indicator for model change
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = message || (preference === 'slow' ? 'Kaliteli Moda Geçiliyor...' : 'Hızlı Moda Geçiliyor...');
            loading.classList.remove('hidden');
            loading.classList.add('flex');
        }
        
        function hideModelChangeLoading() {
            // Hide loading indicator
            const loading = document.getElementById('loading');
            loading.classList.remove('flex');
            loading.classList.add('hidden');
        }
        
        function showModelChangeToast(preference) {
            // Create and show a toast notification for model change
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 glass-card p-4 text-white z-50 animate-tooltip toast-notification';
            toast.innerHTML = preference === 'slow' 
                ? 'Kaliteli Moda Geçildi (Daha Yavaş, Daha Doğru)' 
                : 'Hızlı Moda Geçildi (Daha Hızlı)';
            
            document.body.appendChild(toast);
            
            // Remove toast after animation completes
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        function showApiKeyToast(success, errorMessage) {
            // Create and show a toast notification for API key operations
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 glass-card p-4 text-white z-50 animate-tooltip toast-notification';
            
            if (success) {
                toast.innerHTML = 'API anahtarı başarıyla kaydedildi';
            } else {
                toast.innerHTML = 'API anahtarı kaydedilemedi' + (errorMessage ? ': ' + errorMessage : '');
            }
            
            document.body.appendChild(toast);
            
            // Remove toast after animation completes
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        function showImageProcessingToast() {
            // Create and show a toast notification for image processing
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 glass-card p-4 text-white z-50 animate-tooltip toast-notification';
            toast.innerHTML = 'Görsel işleniyor...';
            
            document.body.appendChild(toast);
            
            // Remove toast after animation completes
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        function clearExistingToasts() {
            // Remove any existing toast notifications
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());
        }

        function previewImage(input) {
            const preview = document.getElementById('preview');
            const uploadArea = document.getElementById('uploadArea');
            const previewArea = document.getElementById('previewArea');

            if (input.files && input.files[0]) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    preview.src = e.target.result;
                    uploadArea.classList.add('hidden');
                    previewArea.classList.remove('hidden');
                }

                reader.readAsDataURL(input.files[0]);
            }
        }

        function showLoading() {
            // Default loading without specific message
            showLoadingWithMessage('İşleniyor...');
        }
        
        function showLoadingWithMessage(message) {
            // Show loading indicator with specific message
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = message;
            loading.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        const fileUpload = document.querySelector('.file-upload');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileUpload.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileUpload.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileUpload.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            fileUpload.classList.add('border-indigo-400');
            fileUpload.classList.add('bg-indigo-500/10');
        }

        function unhighlight(e) {
            fileUpload.classList.remove('border-indigo-400');
            fileUpload.classList.remove('bg-indigo-500/10');
        }

        fileUpload.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            document.getElementById('imageUpload').files = files;
        }

        async function uploadImage() {
            const fileInput = document.getElementById('imageUpload');
            const file = fileInput.files[0];

            if (!file) {
                alert('Lütfen bir resim seçin');
                return;
            }
            
            // Hide question result if visible and show graph container
            document.getElementById('questionResult').classList.add('hidden');
            document.getElementById('graphContainer').classList.remove('hidden');

            showLoading();

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/api/process-image', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!data) {
                    throw new Error('Veri alınamadı');
                }

                if (data.error) {
                    throw new Error(data.error);
                }

                document.getElementById('description').value = data.description || '';

                if (data.question_info && (data.question_info.question || data.question_info.passage || (data.question_info.answers && data.question_info.answers.length > 0))) {
                    document.getElementById('questionInfo').classList.remove('hidden');
                    
                    // Check for passage and display it if available
                    if (data.question_info.passage) {
                        // Create or ensure the passage container exists
                        let passageContainer = document.getElementById('passageContainer');
                        if (!passageContainer) {
                            passageContainer = document.createElement('div');
                            passageContainer.id = 'passageContainer';
                            passageContainer.className = 'mb-4 p-3 bg-gray-50 rounded-lg';
                            
                            // Insert at the beginning of question info
                            const questionInfo = document.getElementById('questionInfo');
                            questionInfo.insertBefore(passageContainer, questionInfo.firstChild);
                        } else {
                            passageContainer.classList.remove('hidden');
                        }
                        passageContainer.textContent = data.question_info.passage;
                    }
                    
                    document.getElementById('questionText').textContent = data.question_info.question || '';

                    const answerList = document.getElementById('answerChoices');
                    answerList.innerHTML = '';
                    if (data.question_info.answers && Array.isArray(data.question_info.answers)) {
                        data.question_info.answers.forEach(answer => {
                            const li = document.createElement('li');
                            li.textContent = answer;
                            answerList.appendChild(li);
                        });
                    }

                    // Populate the display area in the graph section
                    
                    // Also display the passage in the graph display area if available
                    if (data.question_info.passage) {
                        // Create or ensure the passage container exists in display area
                        let displayPassageContainer = document.getElementById('displayPassageContainer');
                        if (!displayPassageContainer) {
                            displayPassageContainer = document.createElement('div');
                            displayPassageContainer.id = 'displayPassageContainer';
                            displayPassageContainer.className = 'mb-4 p-3 bg-gray-50 rounded-lg';
                            
                            // Insert at the beginning of question display area
                            const questionDisplayArea = document.getElementById('questionDisplayArea');
                            questionDisplayArea.insertBefore(displayPassageContainer, questionDisplayArea.firstChild);
                        } else {
                            displayPassageContainer.classList.remove('hidden');
                        }
                        displayPassageContainer.textContent = data.question_info.passage;
                    }
                    
                    document.getElementById('displayQuestionText').textContent = data.question_info.question || '';
                    const displayAnswerList = document.getElementById('displayAnswerChoices');
                    displayAnswerList.innerHTML = '';
                    if (data.question_info.answers && Array.isArray(data.question_info.answers)) {
                        data.question_info.answers.forEach(answer => {
                            const li = document.createElement('li');
                            li.textContent = answer;
                            displayAnswerList.appendChild(li);
                        });
                    }
                    document.getElementById('questionDisplayArea').classList.remove('hidden');
                    document.getElementById('downloadImageBtn').classList.remove('hidden');
                } else {
                    document.getElementById('questionInfo').classList.add('hidden');
                    document.getElementById('questionDisplayArea').classList.add('hidden');
                    document.getElementById('downloadImageBtn').classList.add('hidden');
                }

                // Automatically generate graph if description exists
                if (data.description) {
                    // Show loading animation
                    const graphContainer = document.getElementById('graphContainer');
                    graphContainer.innerHTML = `
                        <div class="flex flex-col items-center py-8">
                            <div class="loader mb-4"></div>
                            <p class="text-gray-500">Grafik oluşturuluyor...</p>
                        </div>
                    `;
                    generateGraph();
                }

            } catch (error) {
                alert('Hata: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function generateGraph() {
            const description = document.getElementById('description').value;

            if (!description) {
                alert('Lütfen bir grafik açıklaması girin');
                return;
            }
            
            // Hide question result if visible and show graph container
            document.getElementById('questionResult').classList.add('hidden');
            document.getElementById('graphContainer').classList.remove('hidden');

            showLoading();

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ description })
                });

                const data = await response.json();

                if (!data) {
                    throw new Error('Veri alınamadı');
                }

                if (data.error) {
                    throw new Error(data.error);
                }

                const graphContainer = document.getElementById('graphContainer');
                graphContainer.innerHTML = `<div class="p-4 bg-white rounded-lg"><img src="data:image/png;base64,${data.image}" alt="Oluşturulan Grafik" class="max-w-full h-auto"></div>`;

            } catch (error) {
                alert('Hata: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function downloadAsImage() {
            const captureArea = document.getElementById('captureArea');
            
            // Show a brief loading indicator
            const loadingEl = document.createElement('div');
            loadingEl.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50';
            loadingEl.innerHTML = `
                <div class="glass-card p-4 flex flex-col items-center">
                    <div class="loader mb-2"></div>
                    <p class="text-indigo-200">Resim oluşturuluyor...</p>
                </div>
            `;
            document.body.appendChild(loadingEl);

            // Capture the combined area
            html2canvas(captureArea, {
                allowTaint: true,
                useCORS: true,
                scale: 2,
                backgroundColor: 'white',
                logging: false
            }).then(canvas => {
                // Create and download the image
                const dataURL = canvas.toDataURL('image/jpeg', 0.9);
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = 'soru_ve_grafik.jpg';
                
                // Remove loading indicator and trigger download
                document.body.removeChild(loadingEl);
                a.click();
            }).catch(error => {
                console.error('Error generating image:', error);
                document.body.removeChild(loadingEl);
                alert('Resim oluşturulurken bir hata oluştu.');
            });
        }
        
        function downloadQuestionAsImage() {
            const captureArea = document.getElementById('questionCaptureArea');
            
            // Show a brief loading indicator
            const loadingEl = document.createElement('div');
            loadingEl.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50';
            loadingEl.innerHTML = `
                <div class="glass-card p-4 flex flex-col items-center">
                    <div class="loader mb-2"></div>
                    <p class="text-indigo-200">Soru resmi oluşturuluyor...</p>
                </div>
            `;
            document.body.appendChild(loadingEl);

            // Capture just the question area (without the title)
            html2canvas(captureArea, {
                allowTaint: true,
                useCORS: true,
                scale: 2,
                backgroundColor: 'white',
                logging: false
            }).then(canvas => {
                // Create and download the image
                const dataURL = canvas.toDataURL('image/jpeg', 0.9);
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = 'yeni_soru.jpg';
                
                // Remove loading indicator and trigger download
                document.body.removeChild(loadingEl);
                a.click();
            }).catch(error => {
                console.error('Error generating question image:', error);
                document.body.removeChild(loadingEl);
                alert('Soru resmi oluşturulurken bir hata oluştu.');
            });
        }
        // Question generation feature
        function setupQuestionGenerationFeature() {
            const questionImageUpload = document.getElementById('questionImageUpload');
            const questionImageInput = document.getElementById('questionImageInput');
            const questionPreviewContainer = document.getElementById('questionPreviewContainer');
            const questionPreview = document.getElementById('questionPreview');
            const cancelQuestionUpload = document.getElementById('cancelQuestionUpload');
            const generateNewQuestionBtn = document.getElementById('generateNewQuestionBtn');
            const questionResult = document.getElementById('questionResult');
            
            // Click event for the upload area
            questionImageUpload.addEventListener('click', function() {
                questionImageInput.click();
            });
            
            // File input change event
            questionImageInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    previewQuestionImage(e.target.files[0]);
                }
            });
            
            // Cancel upload button
            cancelQuestionUpload.addEventListener('click', function() {
                resetQuestionUpload();
            });
            
            // Generate new question button
            generateNewQuestionBtn.addEventListener('click', function() {
                generateNewQuestion();
            });
            
            // Drag and drop for question image upload
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                questionImageUpload.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                questionImageUpload.addEventListener(eventName, () => {
                    questionImageUpload.classList.add('border-indigo-400');
                    questionImageUpload.classList.add('bg-indigo-900/20');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                questionImageUpload.addEventListener(eventName, () => {
                    questionImageUpload.classList.remove('border-indigo-400');
                    questionImageUpload.classList.remove('bg-indigo-900/20');
                }, false);
            });
            
            questionImageUpload.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                if (file) {
                    previewQuestionImage(file);
                }
            }, false);
        }
        
        function previewQuestionImage(file) {
            const questionPreviewContainer = document.getElementById('questionPreviewContainer');
            const questionPreview = document.getElementById('questionPreview');
            const generateNewQuestionBtn = document.getElementById('generateNewQuestionBtn');
            const questionResult = document.getElementById('questionResult');
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                questionPreview.src = e.target.result;
                questionPreviewContainer.classList.remove('hidden');
                generateNewQuestionBtn.classList.remove('hidden');
                questionResult.classList.add('hidden');
            };
            reader.readAsDataURL(file);
            
            // Store the file for upload
            window.questionFile = file;
        }
        
        function resetQuestionUpload() {
            const questionImageInput = document.getElementById('questionImageInput');
            const questionPreviewContainer = document.getElementById('questionPreviewContainer');
            const generateNewQuestionBtn = document.getElementById('generateNewQuestionBtn');
            
            questionImageInput.value = "";
            questionPreviewContainer.classList.add('hidden');
            generateNewQuestionBtn.classList.add('hidden');
            window.questionFile = null;
        }
        
        function checkIfMathQuestion(originalAnswers, newAnswers) {
            // Math questions usually have answers with numbers and simple format like [A. number]
            let mathPatterns = 0;
            
            // Check if original answers match math answer patterns
            for (const answer of originalAnswers) {
                // Look for patterns like "[A. 10]" or "[C. 15]" and similar
                if (/^\[?[A-D]\. \d+(\.\d+)?\]?$/.test(answer.trim())) {
                    mathPatterns++;
                }
                // Look for common math terms in the answers
                if (answer.includes('=') || answer.includes('+') || answer.includes('-') || 
                    answer.includes('×') || answer.includes('÷') || 
                    answer.includes('*') || answer.includes('/')) {
                    mathPatterns++;
                }
            }
            
            // Also check new answers
            for (const answer of newAnswers) {
                if (/^\[?[A-D]\. \d+(\.\d+)?\]?$/.test(answer.trim())) {
                    mathPatterns++;
                }
                if (answer.includes('=') || answer.includes('+') || answer.includes('-') || 
                    answer.includes('×') || answer.includes('÷') || 
                    answer.includes('*') || answer.includes('/')) {
                    mathPatterns++;
                }
            }
            
            // If we have at least a few matches, it's likely a math question
            return mathPatterns >= 2;
        }
        
        function findRepeatedSentence(text) {
            // Split the text into sentences (considering multiple types of delimiters)
            const sentences = text.split(/(?<=[.!?])\s+/);
            const result = {
                found: false,
                cleanedText: text
            };
            
            // If only one sentence, there's no repetition
            if (sentences.length <= 1) return result;
            
            // Look for any sentence that appears more than once
            const seen = new Map();
            const repeats = [];
            
            for (const sentence of sentences) {
                const trimmed = sentence.trim();
                if (trimmed.length < 5) continue; // Skip very short fragments
                
                if (seen.has(trimmed)) {
                    repeats.push(trimmed);
                } else {
                    seen.set(trimmed, true);
                }
            }
            
            // If we found repeats, create a clean version without repetition
            if (repeats.length > 0) {
                result.found = true;
                let cleanedText = text;
                
                for (const repeat of repeats) {
                    // Keep only the first instance of each repeated sentence
                    const firstIndex = cleanedText.indexOf(repeat);
                    const restOfText = cleanedText.substring(firstIndex + repeat.length);
                    const secondIndex = restOfText.indexOf(repeat);
                    
                    if (secondIndex !== -1) {
                        cleanedText = cleanedText.substring(0, firstIndex + repeat.length) + 
                                     restOfText.replace(repeat, '').trim();
                    }
                }
                
                result.cleanedText = cleanedText;
            }
            
            return result;
        }
        
        function extractMathQuestion(text) {
            // This function handles the specific case shown in the example,
            // where a math problem statement is followed by the same question statement
            
            // First, try to find the last question
            const questionMarks = text.split('?');
            if (questionMarks.length <= 2) return text; // No repeated questions
            
            const lastFullQuestion = questionMarks[questionMarks.length - 2].trim() + '?';
            
            // Check if the last question appears elsewhere in the text
            const firstOccurrence = text.indexOf(lastFullQuestion);
            const secondOccurrence = text.indexOf(lastFullQuestion, firstOccurrence + 1);
            
            if (secondOccurrence !== -1) {
                // If the question is repeated, return everything up to the first occurrence of the last question
                // (including the question itself)
                return text.substring(0, firstOccurrence + lastFullQuestion.length).trim();
            }
            
            return text;
        }
        
        function generateNewQuestion() {
            if (!window.questionFile) {
                return;
            }
            
            // Clear any existing toast notifications
            clearExistingToasts();
            
            // Show a toast for image processing
            showImageProcessingToast();
            
            // Show loading with the correct message for image processing
            showLoadingWithMessage('Görsel işleniyor...');
            
            const formData = new FormData();
            formData.append('image', window.questionFile);
            
            fetch('/api/generate-new-question', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // First check if the response is ok
                if (!response.ok) {
                    // Try to parse as JSON first
                    return response.text().then(text => {
                        let errorMessage = 'Something went wrong';
                        
                        try {
                            // Try to parse the response as JSON
                            const data = JSON.parse(text);
                            if (data && data.error) {
                                errorMessage = data.error;
                            }
                        } catch (e) {
                            // If it's not valid JSON, check if it's HTML
                            if (text.includes('<!doctype') || text.includes('<html')) {
                                errorMessage = 'Server returned an HTML error page instead of JSON';
                            } else {
                                errorMessage = text;
                            }
                        }
                        
                        throw new Error(errorMessage);
                    });
                }
                
                // If response is ok, try to parse as JSON
                return response.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('Failed to parse JSON response:', text);
                        throw new Error('Invalid JSON response from server');
                    }
                });
            })
            .then(data => {
                displayQuestionResults(data);
                hideLoading();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
                hideLoading();
            });
        }
        
        function displayQuestionResults(data) {
            const graphContainer = document.getElementById('graphContainer');
            const questionDisplayArea = document.getElementById('questionDisplayArea');
            const questionResult = document.getElementById('questionResult');
            const originalQuestion = document.getElementById('originalQuestion');
            const originalAnswers = document.getElementById('originalAnswers');
            const newQuestion = document.getElementById('newQuestion');
            const newAnswers = document.getElementById('newAnswers');
            const originalPassageContainer = document.getElementById('originalPassageContainer');
            const originalPassage = document.getElementById('originalPassage');
            const newPassageContainer = document.getElementById('newPassageContainer');
            const newPassage = document.getElementById('newPassage');
            
            // Handle original passage if present
            if (data.original_passage && data.original_passage.trim() !== "") {
                originalPassage.textContent = data.original_passage;
                originalPassageContainer.classList.remove("hidden");
            } else {
                originalPassageContainer.classList.add("hidden");
            }
            
            // Handle new passage if present
            if (data.new_passage && data.new_passage.trim() !== "") {
                newPassage.textContent = data.new_passage;
                newPassageContainer.classList.remove("hidden");
            } else {
                newPassageContainer.classList.add("hidden");
            }
            
            // Check if this is a math question by analyzing the answers (usually letters with numbers)
            const isMathQuestion = checkIfMathQuestion(data.original_answers, data.new_answers);
            
            // For math questions, check if the question statement is repeated in the beginning of the question
            let originalQuestionText = data.original_question;
            let newQuestionText = data.new_question;
            
            if (isMathQuestion) {
                // First, check if the new question contains the same sentence repeated (common with math questions)
                const repeatedSentenceCheck = findRepeatedSentence(newQuestionText);
                if (repeatedSentenceCheck.found) {
                    newQuestionText = repeatedSentenceCheck.cleanedText;
                }
                
                // Also check the original question for repeats
                const originalRepeatedCheck = findRepeatedSentence(originalQuestionText);
                if (originalRepeatedCheck.found) {
                    originalQuestionText = originalRepeatedCheck.cleanedText;
                }
                
                // Also detect the pattern from the example where the final question is repeated
                if (originalQuestionText.indexOf('?') !== -1 && originalQuestionText.indexOf('?') !== originalQuestionText.lastIndexOf('?')) {
                    // Find the last question in the text
                    const lastQuestion = originalQuestionText.split('?').slice(-2)[0].trim() + '?';
                    // Check if this question appears multiple times
                    if (originalQuestionText.indexOf(lastQuestion) !== originalQuestionText.lastIndexOf(lastQuestion)) {
                        // Keep only the question and any context before it that's not a repeat
                        originalQuestionText = extractMathQuestion(originalQuestionText);
                    }
                }
                
                // Apply the same logic to the new question
                if (newQuestionText.indexOf('?') !== -1 && newQuestionText.indexOf('?') !== newQuestionText.lastIndexOf('?')) {
                    const lastQuestion = newQuestionText.split('?').slice(-2)[0].trim() + '?';
                    if (newQuestionText.indexOf(lastQuestion) !== newQuestionText.lastIndexOf(lastQuestion)) {
                        newQuestionText = extractMathQuestion(newQuestionText);
                    }
                }
            }
            
            // Display original question and answers
            originalQuestion.textContent = originalQuestionText;
            originalAnswers.innerHTML = '';
            data.original_answers.forEach(answer => {
                const div = document.createElement('div');
                div.className = 'p-2 rounded bg-indigo-950/40';
                div.textContent = answer;
                originalAnswers.appendChild(div);
            });
            
            // Display new question and answers
            newQuestion.textContent = newQuestionText;
            newAnswers.innerHTML = '';
            data.new_answers.forEach(answer => {
                const div = document.createElement('div');
                div.className = 'p-2 rounded border border-gray-300 bg-gray-50 text-black'; 
                div.textContent = answer;
                newAnswers.appendChild(div);
            });
            
            // Setup the download button event listener
            document.getElementById('downloadQuestionBtn').addEventListener('click', downloadQuestionAsImage);
            
            // Hide the default graph elements and show the question result
            graphContainer.classList.add('hidden');
            questionDisplayArea.classList.add('hidden');
            questionResult.classList.remove('hidden');
            
            // Make sure the download button is hidden as it's only for graphs
            document.getElementById('downloadImageBtn').classList.add('hidden');
            
            // Scroll to the results area
            document.querySelector('.glass-card h2').scrollIntoView({behavior: 'smooth'});
        }
    </script>
</body>
</html>
